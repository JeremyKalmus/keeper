#!/bin/bash
# bd wrapper - Intercepts bd commands to invoke Gas Town plugin hooks
#
# This wraps the real bd binary to:
# 1. Call real bd
# 2. Call PostBeadCreate hook (advisory guidance)
#
# NOTE: Keeper validation happens BEFORE beads are created via the
# mol-keeper-evaluate agent. The pre-convoy hook gates convoy creation.

set -euo pipefail

# Find the real bd binary (skip this wrapper)
SELF="$(realpath "${BASH_SOURCE[0]}" 2>/dev/null || readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
BD_REAL=""

IFS=':' read -ra PATH_DIRS <<< "$PATH"
for dir in "${PATH_DIRS[@]}"; do
    candidate="$dir/bd"
    if [[ -x "$candidate" ]] && [[ "$(realpath "$candidate" 2>/dev/null || echo "$candidate")" != "$SELF" ]]; then
        if [[ -L "$candidate" ]]; then
            target="$(readlink -f "$candidate" 2>/dev/null || readlink "$candidate")"
            [[ "$target" == "$SELF" ]] && continue
        fi
        BD_REAL="$candidate"
        break
    fi
done

if [[ -z "$BD_REAL" ]]; then
    BD_REAL=$(find /opt/homebrew/Cellar/bd -name "bd" -type f 2>/dev/null | head -1)
fi

if [[ -z "$BD_REAL" || ! -x "$BD_REAL" ]]; then
    echo "Error: Could not find real bd binary" >&2
    exit 1
fi

# Find Gas Town root (look for .gt directory, NOT .beads which exists in rigs too)
find_town_root() {
    local dir="${1:-$(pwd)}"
    while [[ "$dir" != "/" ]]; do
        # Town root has .gt directory (not just .beads)
        if [[ -d "$dir/.gt" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    # Fallback to ~/gt if it has .gt
    if [[ -d "$HOME/gt/.gt" ]]; then
        echo "$HOME/gt"
        return 0
    fi
    return 1
}

GT_TOWN_ROOT="${GT_TOWN_ROOT:-$(find_town_root || echo "")}"

# If not a create command, pass through directly
if [[ "${1:-}" != "create" && "${1:-}" != "new" ]]; then
    exec "$BD_REAL" "$@"
fi

# Extract title, type, description from args for gate check
TITLE=""
TYPE="task"
DESC=""
ARGS=("$@")

i=0
while [[ $i -lt ${#ARGS[@]} ]]; do
    arg="${ARGS[$i]}"
    case "$arg" in
        create|new)
            ;;
        --title=*)
            TITLE="${arg#*=}"
            ;;
        --title)
            ((i++))
            TITLE="${ARGS[$i]:-}"
            ;;
        --type=*)
            TYPE="${arg#*=}"
            ;;
        --type)
            ((i++))
            TYPE="${ARGS[$i]:-task}"
            ;;
        --description=*|-d=*)
            DESC="${arg#*=}"
            ;;
        --description|-d)
            ((i++))
            DESC="${ARGS[$i]:-}"
            ;;
        -*)
            if [[ "$arg" != *"="* ]]; then
                next="${ARGS[$((i+1))]:-}"
                if [[ "${next:0:1}" != "-" && -n "$next" ]]; then
                    ((i++))
                fi
            fi
            ;;
        *)
            if [[ -z "$TITLE" ]]; then
                TITLE="$arg"
            fi
            ;;
    esac
    ((i++))
done

# Find rig root from current directory or routes
GT_RIG_ROOT="$GT_TOWN_ROOT"
if [[ -n "$GT_TOWN_ROOT" ]]; then
    # Try to determine rig from cwd
    CWD="$(pwd)"
    if [[ "$CWD" == "$GT_TOWN_ROOT"/* ]]; then
        REL_PATH="${CWD#$GT_TOWN_ROOT/}"
        RIG_NAME="${REL_PATH%%/*}"
        if [[ -d "$GT_TOWN_ROOT/$RIG_NAME/.beads" ]] || [[ -d "$GT_TOWN_ROOT/$RIG_NAME/mayor" ]]; then
            GT_RIG_ROOT="$GT_TOWN_ROOT/$RIG_NAME"
        fi
    fi
fi

# ============================================
# Create the bead
# ============================================
# NOTE: Keeper validation happens BEFORE beads are created via the
# mol-keeper-evaluate agent, NOT at bd create time. The pre-convoy
# hook validates that keeper_decision.yaml exists and is approved.
OUTPUT=$("$BD_REAL" "$@" 2>&1) || {
    RC=$?
    echo "$OUTPUT"
    exit $RC
}
echo "$OUTPUT"

# If no town root, skip post hooks
if [[ -z "$GT_TOWN_ROOT" ]]; then
    exit 0
fi

# Parse bead ID from output
BEAD_ID=$(echo "$OUTPUT" | grep -oE '\b[a-z]{2,3}-[a-z0-9]{3,6}\b' | head -1 || echo "")

if [[ -z "$BEAD_ID" ]]; then
    exit 0
fi

# ============================================
# POST: Call PostBeadCreate hook (add guidance)
# ============================================
POST_HOOK=""
for hook_path in \
    "${GT_TOWN_ROOT}/plugins/keeper/hooks/post-bead-create" \
    "${GT_TOWN_ROOT}/.gt/hooks/post-bd-create.sh" \
    "${HOME}/.keeper/hooks/post-bead-create"; do
    if [[ -x "$hook_path" ]]; then
        POST_HOOK="$hook_path"
        break
    fi
done

if [[ -n "$POST_HOOK" ]]; then
    BD_BEAD_ID="$BEAD_ID" \
    BD_BEAD_TITLE="$TITLE" \
    BD_BEAD_DESCRIPTION="$DESC" \
    BD_BEAD_TYPE="$TYPE" \
    GT_TOWN_ROOT="$GT_TOWN_ROOT" \
    GT_RIG_ROOT="$GT_RIG_ROOT" \
    "$POST_HOOK" 2>&1 || true
fi
